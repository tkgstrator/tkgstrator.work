---
title: 金イクラは近くから拾うとどのくらい損なのか
date: 2021-12-14
categoriy: サーモンラン
---

## 納品数を増やす方法

さて、よく金イクラの納品数を最大化する際に「遠くの金イクラも積極的に拾おう」というように教わると思う。

確かに、近くのを全部拾いきってしまえば遠くのを拾いにいくしかないが、遠くのイクラはタマヒロイに回収されやすいという特性がある。つまり、近くのを拾い終わってから遠くのイクラを拾おうとしたら既になくなっているという場合があるわけである。

よって、最終的に近くの金イクラが回収可能であるのであれば遠くから拾ったほうが「良さそう」に思える。

そしてこの時、以下のような疑問が生じる。

- 距離 L の金イクラを拾ったのであれば L 未満の全ての金イクラを回収しきらないと損なのか
- 近くから拾っていくという戦略はどのくらい損なのか
- 最良のイクラ回収戦略はどのようなものか

### 問題を簡略化する

バカ正直に考えるといくらでも難しくなってしまうので、ここでは問題を単純化する。

- 金イクラはタマヒロイに回収されない
- 金イクラ回収のコストは距離だけに依存する
  - 遠くだからシャケに邪魔されやすくて拾いにくいなどは考えない
- 198 個の金イクラが 0 秒時点で全てドロップしているとする
  - それらをできるだけ多く 300 秒で回収する
- ホストでの回収のしやすさは考えない

プレイヤーは四人おり、それぞれプレイヤーには 300 秒分の回収能力がある。よって、四人で 1200 秒の回収能力があるということになる。

そして、それぞれのイクラに回収にかかるコストがあり、なるべく多くプレイヤーに割り当てるということを考える。

で、ここまで書いて分かる人もいると思うがこれはナップサック問題のそれに似ている。ナップサック問題は整数計画問題の一つであり、IP ソルバを用いて現実的な時間内でほとんど最適な解を得ることができる。

::: tip ナップサック問題化する

この問題をナップサック問題化すると運搬力$W$のプレイヤーが四人おり、価値$v_i$, コスト$w_i$のイクラをなるべく運ぶという問題になる。

:::

### この問題の難しさ

ほとんど最適な解、と書いたが最適な解が得られることは保証していない、何故か。

それはこの問題が NP-Hard と呼ばれる計算量クラスに属しているためであり、全ての組み合わせをチェックしないと解くことができないからである。

この問題は結局一つのイクラに対して、

1. 拾わない
2. A が拾う
3. B が拾う
4. C が拾う
5. D が拾う

という五つのどれかを割り当てるので、イクラの数が 198 個あるとするとその組み合わせは$5^{198}~=2.489306*10^{138}$にもなり、全く現実的ではない。よって、近似計算に頼るほかなく、理論値を得るのは期待できない。

## 問題を考える

折角なので以下の三つの問題を考えてみた。

1. ランダムにコストを与える
2. 寄せたと考えてコストを与える
3. ものすごく寄せたと考えてコストを与える

一つは完全にランダムにコストを与えるというものである。これはモグラを寄せるとかそういうことを全く考えないものである。

二つ目はモグラとテッパンを寄せたと考えてコストを与える。この場合、それらの金イクラには非常に小さい定数コストを与える。モグラとテッパンは 2/7 の確率で出現するので、56 個の金イクラがこれらに該当する。

三つ目はものすごく寄せたと考えてヘビやバクダンにもそれなりに小さい定数コストを与える。これらも 56 個の金イクラが該当する。

### MIP ソルバで解く

この問題は IP ソルバではなく MIP ソルバで解くのが良い。

いきなり$n=198$を与えると MIP ソルバちゃんがびっくりしてしまうのでまずは小さい問題として$n=5$を与えてみる。

- イクラのコスト$w_i$
  - $[3, 4, 4, 3, 4]$
- プレイヤーの容量$W_i$
  - $[5, 5, 5, 5]$

コストの合計が 18 でプレイヤーの容量の合計が 20 なので全て運べそうな気がするが、コストの最低が 3 なので一人で二つのイクラを運べるプレイヤーがいないことがすぐにわかる。つまり、どうがんばっても四つしか運べないことになる。

ただし、この場合は誰がどのイクラを拾っても良いことにもなっている。

この時、ソルバから辞書形式で解が得られる。それを公式のサンプルコードを参考に中身を表示してみると以下のような感じになります。

```sh
Player 0
Egg 0 cost: 3
Packed egg weight: 3
Packed egg value: 1

Player 1
Egg 1 cost: 4
Packed egg cost: 4
Packed egg value: 1

Player 2
Egg 2 cost: 4
Packed egg cost: 4
Packed egg value: 1

Player 3
Egg 3 cost: 3
Packed egg cost: 3
Packed egg value: 1

Total packed cost: 14 # 運んだイクラのコストの合計
Total packed value: 4 # 四つ運んだ
```

つまり、四人で四つ運べていることがわかります。

```json
{
  "(0, 0)": 1.0,
  "(0, 1)": 0.0,
  "(0, 2)": 0.0,
  "(0, 3)": 0.0,
  "(1, 0)": 0.0,
  "(1, 1)": 1.0,
  "(1, 2)": 0.0,
  "(1, 3)": 0.0,
  "(2, 0)": 0.0,
  "(2, 1)": 0.0,
  "(2, 2)": 1.0,
  "(2, 3)": 0.0,
  "(3, 0)": 0.0,
  "(3, 1)": 0.0,
  "(3, 2)": 0.0,
  "(3, 3)": 1.0,
  "(4, 0)": 0.0,
  "(4, 1)": 0.0,
  "(4, 2)": 0.0,
  "(4, 3)": 0.0
}
```

中身を JSON として出力するとこんな感じで、`(ItemId, PlayerId): isCollected`という状態を表しています。よって全ての組み合わせで 0 になっている五つ目のイクラは誰も運んでいないので、結果的に運べなかったということがわかります。
